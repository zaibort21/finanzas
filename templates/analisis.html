<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis 50/30/20 - FinanzasPro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-icon">üí∞</span>
                <span class="logo-text">FinanzasPro</span>
            </div>
            <ul class="nav-menu">
                <li><a href="/">Inicio</a></li>
                <li><a href="/analisis" class="active">An√°lisis 50/30/20</a></li>
                <li><a href="/metas">Metas de Ahorro</a></li>
                <li><a href="/recomendaciones">Biblioteca Financiera</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <h1 class="page-title">üìä An√°lisis 50/30/20</h1>
        <p class="page-subtitle">Ingresa tus ingresos y gastos para recibir un diagn√≥stico personalizado</p>

        <div class="analisis-grid">
            <div class="input-section card">
                <h2>Datos Financieros</h2>
                
                <div class="form-group">
                    <label for="ingresos">Ingresos Mensuales ($)</label>
                    <input type="number" id="ingresos" placeholder="Ej: 50000" min="0" step="1000">
                </div>

                <h3>Gastos</h3>
                <div id="gastos-container">
                    <!-- Los gastos se agregar√°n din√°micamente aqu√≠ -->
                </div>

                <button id="agregar-gasto" class="btn-secondary">+ Agregar Gasto</button>
                <button id="analizar-btn" class="btn-primary" style="margin-top: 20px;">Analizar Finanzas</button>
            </div>

            <div class="result-section card" id="resultados" style="display: none;">
                <h2>Resultados del An√°lisis</h2>
                
                <div class="resumen-ingresos">
                    <p>Ingresos Mensuales: <strong>$<span id="resumen-ingresos">0</span></strong></p>
                </div>

                <div class="grafica-barras">
                    <div class="barra-container">
                        <div class="barra-label">Necesidades</div>
                        <div class="barra-fondo">
                            <div id="barra-necesidades" class="barra-lleno" style="width: 0%"></div>
                        </div>
                        <div class="barra-porcentaje" id="porc-necesidades">0%</div>
                    </div>
                    <div class="barra-container">
                        <div class="barra-label">Deseos</div>
                        <div class="barra-fondo">
                            <div id="barra-deseos" class="barra-lleno" style="width: 0%"></div>
                        </div>
                        <div class="barra-porcentaje" id="porc-deseos">0%</div>
                    </div>
                    <div class="barra-container">
                        <div class="barra-label">Ahorro</div>
                        <div class="barra-fondo">
                            <div id="barra-ahorro" class="barra-lleno" style="width: 0%"></div>
                        </div>
                        <div class="barra-porcentaje" id="porc-ahorro">0%</div>
                    </div>
                </div>

                <div class="diagnosticos" id="diagnosticos-container">
                    <!-- Los diagn√≥sticos se insertar√°n aqu√≠ -->
                </div>

                <div class="ahorro-disponible" id="ahorro-disponible-container">
                    <!-- Informaci√≥n de ahorro disponible -->
                </div>
            </div>
        </div>
    </main>

    <script>
        // Template para gastos
        let gastoCount = 0;

        document.getElementById('agregar-gasto').addEventListener('click', function() {
            const container = document.getElementById('gastos-container');
            const gastoDiv = document.createElement('div');
            gastoDiv.className = 'gasto-item';
            gastoDiv.innerHTML = `
                <input type="text" placeholder="Descripci√≥n" class="gasto-descripcion">
                <input type="number" placeholder="Monto" class="gasto-monto" min="0" step="100">
                <select class="gasto-categoria">
                    <option value="necesidad">Necesidad</option>
                    <option value="deseo">Deseo</option>
                    <option value="ahorro">Ahorro/Inversi√≥n</option>
                </select>
                <button class="btn-eliminar" onclick="this.parentElement.remove()">üóëÔ∏è</button>
            `;
            container.appendChild(gastoDiv);
            gastoCount++;
        });

        // Agregar primer gasto por defecto
        window.onload = function() {
            document.getElementById('agregar-gasto').click();
            document.getElementById('agregar-gasto').click();
            document.getElementById('agregar-gasto').click();
        };

        document.getElementById('analizar-btn').addEventListener('click', function() {
            const ingresos = parseFloat(document.getElementById('ingresos').value) || 0;
            
            const gastos = [];
            document.querySelectorAll('.gasto-item').forEach(item => {
                const descripcion = item.querySelector('.gasto-descripcion').value;
                const monto = parseFloat(item.querySelector('.gasto-monto').value) || 0;
                const categoria = item.querySelector('.gasto-categoria').value;
                
                if (monto > 0) {
                    gastos.push({ descripcion, monto, categoria });
                }
            });

            if (ingresos <= 0) {
                alert('Por favor ingresa tus ingresos mensuales');
                return;
            }

            if (gastos.length === 0) {
                alert('Agrega al menos un gasto');
                return;
            }

            // Enviar al backend
            fetch('/api/analizar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ingresos, gastos })
            })
            .then(response => response.json())
            .then(data => {
                mostrarResultados(data);
            });
        });

        function mostrarResultados(data) {
            document.getElementById('resultados').style.display = 'block';
            
            // Actualizar resumen
            document.getElementById('resumen-ingresos').textContent = data.ingresos.toLocaleString('es-MX');
            
            // Actualizar barras
            document.getElementById('barra-necesidades').style.width = data.porcentajes.necesidades + '%';
            document.getElementById('porc-necesidades').textContent = data.porcentajes.necesidades + '%';
            
            document.getElementById('barra-deseos').style.width = data.porcentajes.deseos + '%';
            document.getElementById('porc-deseos').textContent = data.porcentajes.deseos + '%';
            
            document.getElementById('barra-ahorro').style.width = data.porcentajes.ahorro + '%';
            document.getElementById('porc-ahorro').textContent = data.porcentajes.ahorro + '%';
            
            // Mostrar diagn√≥sticos
            const diagnosticosDiv = document.getElementById('diagnosticos-container');
            diagnosticosDiv.innerHTML = '<h3>Diagn√≥stico Personalizado</h3>';
            
            data.diagnosticos.forEach(diag => {
                const diagElement = document.createElement('div');
                diagElement.className = `diagnostico diagnostico-${diag.tipo}`;
                diagElement.innerHTML = `
                    <p class="diagnostico-mensaje">${diag.mensaje}</p>
                    <p class="diagnostico-consejo">üí° ${diag.consejo}</p>
                `;
                diagnosticosDiv.appendChild(diagElement);
            });
            
            // Mostrar ahorro disponible
            const ahorroDiv = document.getElementById('ahorro-disponible-container');
            ahorroDiv.innerHTML = `
                <h3>üí∞ Ahorro Disponible para Metas</h3>
                <p class="ahorro-monto">$${data.ahorro_disponible.toLocaleString('es-MX')} mensuales</p>
                <p class="ahorro-texto">Este es el dinero que podr√≠as destinar a nuevas metas de ahorro seg√∫n la regla 50/30/20.</p>
                <a href="/metas" class="btn-small">Planificar Meta ‚Üí</a>
            `;
        }
    </script>
</body>
</html>